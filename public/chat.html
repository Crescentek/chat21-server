<html>
    <head>
        <script src="https://unpkg.com/mqtt@3.0.0/dist/mqtt.min.js"></script>
    </head>
    <body>
        Hello chat
        <br>
        your id: <input type="text" id="sender"/>
        <input type="button" id="set" value="set" onclick="set_user()"/>
        <br>
        to: <input type="text" id="recipient"/>
        <br>
        message: <input type="text" id="message"/>
        <input type="button" id="send" value="send" onclick="send()"/>
        <div id="messages">
        
        </div>
        <script>
            var user_id;
            var recipient_id;
            var topic_inbox;
            var client;
            var options;

            function set_user() {
                user_id = document.getElementById("sender").value
                console.log("user_id:", user_id)
                var client_id = Date.now()
                if (client) {
                    client.end()
                }
                const presence_topic = 'presence/' + user_id + '/' + client_id
                options = {
                    keepalive: 10,
                    // protocolId: 'MQTT',
                    // protocolVersion: 4,
                    // clean: true,
                    reconnectPeriod: 1000,
                    // connectTimeout: 30 * 1000,
                    will: {
                        topic: presence_topic,
                        payload: '{disconnected:true}',
                        qos: 1,
                        retain: true
                    },
                    // will: {
                    //     topic: 'lost',
                    //     payload: 'somepayload',
                    //     qos: 1,
                    //     retain: false,
                    //     properties: {
                    //         willDelayInterval: 120 /* MQTT 5.0 property saying how many seconds to wait before publishing the LWT message */
                    //     }
                    // },
                    username: 'andrea',
                    password: 'Freedom73',
                    rejectUnauthorized: false
                }
                console.log("starting mqtt connection with LWT on:", presence_topic)
                // client = mqtt.connect('mqtt://127.0.0.1:15675/ws',options)
                client = mqtt.connect('ws://34.253.207.0:15675/ws',options)
                

                // client = mqtt.connect('mqtt://localhost:8888',
                //     {
                //         will: {
                //             topic: presence_topic,
                //             payload: '{disconnected:true}',
                //             qos: 1,
                //             retain: true
                //         }
                //     }
                // )
                client.on('connect',
                    function () {
                        console.log("connected with options:", options)
                    }
                );
                client.on('message', function (topic, message) {
                    var message_json = JSON.parse(message.toString())
                    console.log("got", message_json, " on topic", topic)
                    var topic_parts = topic.split("/")
                    console.log("parts: ", topic_parts)
                    const sender_id = topic_parts[5]
                    add_message(sender_id + ": " + message_json.text)
                })
                subscribe_to_my_inbox(user_id)
            }

            function subscribe_to_my_inbox(user_id) {
                console.log("subscribing to inbox of:", user_id)
                topic_inbox = 'apps/tilechat/users/' + user_id + '/conversations/+'
                client.subscribe(topic_inbox, function (err) {
                    console.log("subscribed to:", topic_inbox, " with err", err)
                })
            }

            function send() {
                recipient_id = document.getElementById("recipient").value
                console.log("recipient_id:", recipient_id)
                var message = document.getElementById("message").value
                add_message("you: " + message)
                dest_topic = 'apps/tilechat/users/' + user_id + "/messages/" + recipient_id
                console.log("dest_topic:", dest_topic)
                // const payload = '{text:""' + message + '""}'
                var outgoing_message = {
                    text: message
                }
                const payload = JSON.stringify(outgoing_message)
                console.log("payload:", payload)
                client.publish(dest_topic, payload)
                // client.publish('sensors/drone01/altitude', 'Hello mqtt')
            }

            function add_message(text) {
                var para = document.createElement("P");
                var t = document.createTextNode(text);
                para.appendChild(t);
                document.getElementById("messages").appendChild(para);
            }

            
        </script>
    </body>
</html>